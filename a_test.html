<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="format-detection" content="telephone=no" />
<meta name="robots" content="nofollow" />
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" /> 
<title>瑜伽会员在线约课系统</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<link rel="stylesheet" href="/yueke/templates/m/base.css" />
<style>
.loadingAjaxWait_Event {color:#ccc;padding: 0px 0px;}

.listCon li {}
.listCon .monthDay { border-bottom: 1px solid #ccc; font-size: 14px; background: #F3CBB8;padding: 0px 15px;}
.listCon .keCon { background: #f2f2f2;padding: 5px 15px; margin: 10px auto;}

.layer-bg {background-color: rgba(0,0,0,0.5);position: fixed;width: 100%;height: 100%;top: 0;bottom:0;left: 0;z-index: 9998;display: none;}
.layer-box {display: none;background-color: #fff;position: fixed;width: 80%; height: 230px;left: 50%;top: 50%;margin-left: -40%;margin-top:-115px;z-index: 9999;border-radius: 10px;box-shadow: 0px 0px 5px #999;}
.layer-box .close {background: url(/yueke/templates/m/images/white_close.png) no-repeat;background-size: cover; position: absolute; width: 30px; height: 30px;top:3px;right:3px;border-radius: 10px;cursor: pointer;z-index: 9;}
.layer-box .text {text-align: center; line-height: 36px;background:#FF7070; color: #fff;font-size: 16px;border-radius: 10px 10px 0 0;}
.layer-box .cont {padding: 15px 20px;text-align: center;}
.layer-box .cont .tit {font-size: 14px; border-bottom: 1px solid #ccc; text-align: center; padding-bottom: 3px; margin-bottom: 3px;}
.layer-box .cont .tit .t_s{font-size: 12px; color: #999; margin-left: 5px;display: inline-block;}
.layer-box .btn { border:1px solid #64B4C5; text-align: center;width: 50%; height: 32px;background:#57C2DA;color: #FFF;font-size: 16px;border-radius: 5px; margin: 0 auto;}
.layer-box .btn.cancelBtn {background: #f2f2f2;color: #999;border: 1px solid #ccc; margin-left: 10px;width: 6em;font-size: 12px;}
</style>
</head>
<body>
<div class="wrap clearfix">
   <button onclick="ajaxSearch('course',0,0)">course</button>
   <button onclick="ajaxSearch('teacher',0,0)">teacher</button>
   <button id="refreshSubmit" class="f_R">刷新</button>
   <div id="content"></div>
</div>

<div class="layer-bg clearfix"></div>
<div class="layer-box clearfix">
          <div class="close closeAjax"></div>
          <div class="text clearfix">处理结果</div>

          <div class="cont clearfix">
                   <div class="tit clearfix">取消本次课程？</div>
                   <div class="conFix clearfix">
                         <select name="bz_class_delayReason_con" id="bz_class_delayReason_con" onblur="deleteSpace(this);">
                               <option value="0">请选择取消原因</option>
                               <option value="1">临时有事，上不了。</option>
                               <option value="2">身体不适，上不了。</option>
                               <option value="3">约错课了，重新约。</option>
                               <option value="4">没原因，不想上了。</option>
                               <option value="5">其它原因，要手写。</option>
                         </select>
                         <span class="bz_Err" id="bz_class_delayReason_Err">*</span>
                         <input style="display:none;margin-top: 5px;" type="text" name="bz_class_delayReason_text" id="bz_class_delayReason_text" placeholder="请填写取消课程的原因" value="" onblur="deleteSpaceLess(this);" />
                   </div>
                   <div class="conAjax clearfix"></div>
          </div>
          <div class="cont clearfix">
                   <button class="btn">确认修改</button>
                   <button class="btn cancelBtn closeAjax">取消修改</button>
          </div>
</div>


<script type="text/javascript" src="/yueke/templates/js/jquery-1.9.1.min.js"></script>
<script>

$(function(){
      ajaxSearch("course",0,0);
})

function ajaxSearch($dataName_value, $refresh_value, $id){
  var $_id_para = '';
  if($id!=0){$_id_para="&courseID="+$id;}
  var $_content = $("#content");
  var $_Refresh = $("#refreshSubmit");
  var $_this = $(this);
  var $_path = "/yueke/a_test.php?action=search&dataName="+$dataName_value+"&dataType=json&refresh="+$refresh_value+$_id_para+"&n="+ Math.random();
      $.ajax({
         type:"GET",
         url:$_path,
         async:true,
         dataType: "json", 
         beforeSend: function (){
		      $_this.unbind("click").addClass("loadingAjaxWait_Event");
		      $_Refresh.unbind("click").addClass("loadingAjaxWait_Event");
		      $_content.addClass("loadingAjaxWait").html("加载中…");
         },
         success: function(o){ 
                      var $data_title='';
                      var $data='';
                      $.each(o,function(idx,item){
                      if($dataName_value == "course"){
                          $data += '<li>';
                          $data += "<div class='monthDay' id='" + idx + "'>";
                          $data += item.monthDay + " ";
                          $data += "</div>";
                          $data += "<div class='keCon'>";
                          $data += "<span class=''>";
                          $data += item.startTime + "-" + item.endTime;
                          $data += "</span>";
                          $data += "<br />";
                          $data += "   [";
                          $data += item.courseCatalogName;
                          $data += "]   ";
                          $data += item.courseCategoryName;
                          $data += "<br />";
                          $data += item.teacherName;
                          $data += "  , ";
                          $data += "<a class='orderNum' href='javascript:void(0)' onclick=\"ajaxSearch('class',0,'"+item.id+"')\">" + item.num + "</a>";
                          $data += "/" + item.count;
                          $data += "<br />";
                          if(item.order==1){
                                $data += "<a class='orderConfirm' href='javascript:void(0)' onclick=\"ajaxOrder(this,'"+item.id+"',0)\">预约</a>";
                                $data += "<a class='orderCancel' style='display:none;' href='javascript:void(0)' onclick=\"ajaxOrder(this,'"+item.id+"',1)\">取消</a>";
                          }else{
                                $data += "<a class='orderConfirm' href='javascript:void(0)'>已约</a>";
                                $data += "<a class='orderCancel' href='javascript:void(0)' onclick=\"ajaxOrder(this,'"+item.id+"',1)\">取消</a>";
                          }
                          $data += "</div>";
                      }else if($dataName_value == "teacher"){
                          $data += '<li>';
                          $data += item.name + " ";
                          $data += item.male + " ";
                          $data += item.phone + " ";
                      }else if($dataName_value == "class"){
                          $data_title = "";
                          $data_title += item.year + "年";
                          $data_title += item.monthDay + " ";
                          $data_title += item.startTime + "-" + item.endTime;
                          $data_title += "  , ";
                          $data_title += item.count;
                          $data_title += "  , ";
                          $data_title += item.num;
                          $data_title += "  , ";
                          $data_title += "   [";
                          $data_title += item.courseCatalogName;
                          $data_title += "]   ";
                          $data_title += item.courseCategoryName + " ,";
                          $data_title += item.teacherName + " ";


                          if(item.isCancel==1){
                               $data += '<li><span style="color:#f00;">已取消</span>';
                          }else{
                               $data += '<li>';
                          }
                          $data += "[";
                          $data += item.adviserName;
                          $data += "] ";
                          $data += item.memberName;
                          $data += "  , ";
                          $data += item.memberPhone;
                          if(item.memberPhone_1.length>0){
                               $data += "  , ";
                               $data += item.memberPhone_1;
                          }
                          $data += "  , ";
                          $data += "<a class='editClass' href='javascript:void(0)' onclick=\"layerShow_classEdit(this,'"+item.id+"','"+ item.isCancel +"')\">修改</a>";
                      }
                      $data += '</li>';
                      }) // each end
                      $data = "<div class='con'><div>" + $data_title + "</div><ul class='listCon clearfix'>" + $data + "</ul></div>";
		      $_content.removeClass("loadingAjaxWait").html($data);

                      if($(".monthDay")){
		          var $monthDay = $(".monthDay");
		          for(var i=$monthDay.length-1;i>0;i--){
		              if( $monthDay.eq(i).text() == $monthDay.eq(i-1).text() ){
 		                 $monthDay.eq(i).remove();
 		              }
		          }

		          var $monthDay_new = $(".monthDay");
                          var $monthDay_v = '';
		          for(var i=0;i<$monthDay_new.length;i++){
		              $monthDay_v += "<span>" + $monthDay_new.eq(i).text() + "</span>";
		          }
                          $(".listCon").prepend($monthDay_v);
                      }

         },
         complete: function(data){
		      $_this.removeClass("loadingAjaxWait_Event").attr("onclick","ajaxSearch('"+$dataName_value+"',0,'"+$id+"')");
		      $_Refresh.removeClass("loadingAjaxWait_Event").attr("onclick","ajaxSearch('"+$dataName_value+"',1,'"+$id+"')");
         },
         error: function (data){
		      $_this.unbind("click").addClass("loadingAjaxWait_Event");
		      $_Refresh.unbind("click").addClass("loadingAjaxWait_Event");
                      $_content.removeClass("loadingAjaxWait").html("结果: " + data.responseText);
         }
      });

}




function ajaxOrder($this,$courseID,$courseCancel){
  if($courseCancel==1){
      var $courseCancel_para = "&courseCancel=1";
  }else{
      var $courseCancel_para = '';
  }
  var $_this = $($this);
  var $_path = "/yueke/a_test.php?action=order&courseID="+$courseID+"&dataType=json&n="+ Math.random() + $courseCancel_para;
      $.ajax({
         type:"GET",
         url:$_path,
         async:true,
         dataType: "json", 
         beforeSend: function (){
		      $_this.removeAttr("onclick").addClass("loadingAjaxWait_Event").html("加载中…");
         },
         success: function(DATA){ 
		      $_this.removeClass("loadingAjaxWait_Event").html(DATA.state);
                      if(DATA.state=="约课成功"){
                          $_this.parents("li:first").find(".orderCancel").fadeIn(1000,function(event){
                                if( $(this).attr("onclick") == undefined ){
                                      $(this).attr("onclick","ajaxOrder(this,'"+$courseID+"',1)").text("取消"); 
                                }
                                var $orderNum = $_this.parents("li:first").find(".orderNum");
                                $orderNum.text( parseInt($orderNum.text())+1 );
                          });
                      }
                      if( DATA.state=="已约" || DATA.state=="已经取消" ){
                          var $orderNum = $_this.parents("li:first").find(".orderNum");
                          if( DATA.courseNum !='' && DATA.courseNum!=parseInt($orderNum.text()) ){
                                $orderNum.text(DATA.courseNum);
                          }
                      }
                      if(DATA.state=="取消成功"){
                          $_this.fadeOut(1000,function(){
                                $_this.parents("li:first").find(".orderConfirm").attr("onclick","ajaxOrder(this,'"+$courseID+"',0)").text("预约"); 
                                var $orderNum = $_this.parents("li:first").find(".orderNum");
                                $orderNum.text( parseInt($orderNum.text())-1 );
                          });
                      }
         },
         complete: function(data){
         },
         error: function (data){
		      $_this.removeAttr("onclick").html("结果: " + data.responseText);
         }
      });

}




function layerShow_classEdit($this,$classID,$isCancel){
	var $_layer_bg = $('.layer-bg');
	var $_layer_box = $('.layer-box');
	$_layer_bg.show();
        /*
	$_layer_bg.on('click', function(){
		layerHide();
    	});
        */
	$_layer_box.show();
	$_layer_box.find('.closeAjax').on('click', function(){
		layerHide();
    	});
        var $info = '';
        $info += '要修改的id是：' + $classID;
	$_layer_box.find(".conAjax").html($info);
	//$_layer_box.find(".btn").attr("href",$url);
        $('body').css('overflow','hidden');
/*
$('.'+$box).find(".btn").bind("click",function() {
  var _AjaxCont = ".box-hotline .cont .fts_1",
      _$path = $url+"&n="+ Math.random(),
      _$n = 1 ;

      $.ajax({
         type:"GET",
         url:_$path,
         async:true,
         dataType: "text", 
         beforeSend: function () {
		      $(_AjaxCont).addClass("loadingAjaxWait").html("");
         },
         success: function(o){ 
		      $(_AjaxCont).removeClass("loadingAjaxWait").html(o);
         },
         complete: function () {
                      _$n++;
         },
         error: function (data) {
                      $(_AjaxCont).append("error: " + data.responseText);
         }
      });
})
*/
}

function layerHide() {
	$('.layer-bg').hide();
	$('.layer-box').hide();
	$('body').css('overflow','auto');
}


if($("#bz_class_delayReason_con")){
     $("#bz_class_delayReason_con").change(function(){
         $("#bz_class_delayReason_Err").removeClass('bz_Err').html("*");
         if($(this).val() == 0){
              $("#bz_class_delayReason").val('');
         }else{
              $("#bz_class_delayReason").val( $("#bz_class_delayReason_con").find("option:selected").text() );
         }
         if($(this).val() == 5){
              $("#bz_class_delayReason_text").css("display","table-row");
              $("#bz_class_delayReason").val('');
              $("#bz_class_delayReason_text").focus();
         }else{
              $("#bz_class_delayReason_text").css("display","none");
         }
     });
}



</script>
</body>
</html>
